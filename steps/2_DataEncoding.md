# データの符号化

# コンテンツ
1. 誤り訂正レベルの選択
データをエンコードする前に誤り訂正レベルを選択する。<br>
導入で述べたように、QRコードは***リードソロモン誤り訂正符号***を使用する。<br>
このプロセスではエンコードされたエータを基に誤り訂正符号を生成する。<br>
QRコードリーダーはこれらの誤り訂正符号を使用して、データを正確に読み取れなかったことを判断することができる。<br>
また誤り訂正符号を用いてこれらの誤りを訂正することができる。<br>
誤り訂正にはL、M、Q、Hの4つのレベルが存在する。<br>

|誤り訂正レベル|誤り訂正能力|
|---|---|
|L|7%までの誤りを訂正可能|
|M|15%までの誤りを訂正可能|
|Q|25%までの誤りを訂正可能|
|H|30%までの誤りを訂正可能|

高い誤り訂正レベルはより多くのデータ容量を要求するため、QRコード自体も大きくなることに注意が必要。

2. データの最小バージョンを決定する
QRコードのサイズの違いは***バージョン***と呼ばれ、利用可能な40のバージョンが存在する。<br>
最小バージョンはバージョン1で21x21ピクセル、<br>
バージョン2は25x25ピクセル、<br>
最大バージョンのバージョン40は177x177ピクセルと、ピクセルサイズが前のバージョンより4大きくなる。<br>

各バージョンはそれぞれ最大容量があり、最大容量は使用するモードに依存する。<br>
加えて誤り訂正レベルによってさらに制限される。<br>
ここに全てのバージョン、誤り訂正レベルのQRコード最大容量を記載する。<br>
https://github.com/riko-teki/QuRi-kinton/blob/main/steps/character_capacities_table.md

  1. 最小バージョンの決定方法
  この時点でエンコード後の文字数をカウントし、指定されたエンコードモードと誤り訂正レベルの文字数を含めることができる最小バージョンを決定する。<br>
  例えば、***HELLO WORLD***というフレーズは11文字である。![文字数容量テーブル](https://github.com/riko-teki/QuRi-kinton/blob/main/steps/character_capacities_table.md)を見るとバージョン1のQRコードで誤り訂正レベルQを使用した場合英数字16文字を含めることができる。<br>
  つまり、バージョン1がこの文字数にとっての最小バージョンということになる。<br>
  フレーズが***HELLO THERE WORLD***のように16文字より長い場合、最小バージョンは2になる。<br>
  3. 上限
  最も容量が大きいQRコードはバージョン40の誤り訂正レベルがLのものである。(以下40-Lの形式で記載)
  40-M、40-Q、40-Hは誤り訂正符号のためのスペースを要求するため40-Lと比較して容量が少ない。

3. モードインジケータの追加
各エンコードモードにはそれを識別するための4bitモードインジケーターがある。<br>
エンコードされたデータは、その後のbitに使用するモードを指定する、適切なモードインジケーターで始まらなけらばいけない。<br>
下に各モードのモードインジケーターを示す。<br>

例えば、***HELLO WORLD***を英数字モードでエンコードする場合、モードインジケーターは***0010***となる。

|モード名|モードインジケーター|
|---|---|
|数字|0001|
|英数字|0010|
|バイト|0100|
|漢字|1000|
|ECI|0111|

4. 文字カウントインジケータの追加
文字カウントインジケーターはエンコード後の文字数を表現するビット文字列である。<br>
文字カウントインジケーターはモードインジケーターの後に配置されなければならない。さらにQRバージョンに依存する特定のビット長でなければならない。<br>
基の入力テキストの文字数をカウントし、次にその数値をバイナリに変換する。<br>
文字カウントインジケーターの長さはエンコードモードと使用するQRコードのバージョンに依存する。<br>
適切な長さのバイナリ文字列を作るために、左側に0を埋め込む。<br>
次のリストは各モード、バージョンにおける文字カウントインジケーターのサイズである。<br>
例えば、***HELLO WORLD***をバージョン1、英数字モードでエンコードする場合、文字カウントインジケーターの長さは9bitでなければならない。<br>
***HELLO WORLD***の文字数は11であり、バイナリ表記にすると1011になる。<br>
9bit長にするために左側に0を埋め込み、000001011とする。ステップ3で得たモードインジケーターの後に配置すると***0010000001011***というbit文字列が得られる。

  1. バージョン、モード毎の文字カウントインジケーター長
  
  |モード名|1\~9|10\~26|27\~40|
  |---|---|---|---|
  |数字|10bits|12bits|14bits|
  |英数字|9bits|11bits|13bits|
  |バイト|8bits|16bits|16bits|
  |漢字|8bits|10bits|12bits|

5. 選択したモードを使用した符号化
6. 8bitのコードワードに分割し、必要に応じてパッドバイトを追加する
  1. QRコードの必要ビット数を決定する
  2. 必要に応じて0ターミネーターを追加する
  3. 長さを8の倍数にするために0を追加する
  4. 文字列がまだ短すぎる場合、パッドバイトを追加する
7. 次のステップ
